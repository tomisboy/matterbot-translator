FROM mysql:5.7

RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 467B942D3A79BD29
RUN apt-get update && apt-get install -y ca-certificates

ENV MYSQL_ROOT_PASSWORD=$SECRET-PASS-ROOT
ENV MYSQL_USER=mmuser
ENV MYSQL_PASSWORD=$SECRET-PASS
ENV MYSQL_DATABASE=mattermost_test
######
# sed -i 's/$SECRET-PASS-ROOT/gitsecret/g' Dockerfile
# sed -i 's/$SECRET-PASS/gitsecret/g' Dockerfile

WORKDIR /mm


ADD https://releases.mattermost.com/6.6.0/mattermost-team-6.6.0-linux-amd64.tar.gz .
RUN tar -zxvf mattermost-team-*-linux-amd64.tar.gz
ADD config_docker.json ./mattermost/config/config_docker.json
ADD docker-entry.sh .

RUN chmod +x ./docker-entry.sh
ENTRYPOINT ./docker-entry.sh

# Mattermost environment variables
ENV PATH="/mm/mattermost/bin:${PATH}"

# Create default storage directory
RUN mkdir ./mattermost-data
VOLUME /mm/mattermost-data

# Ports
EXPOSE 8065